### 폴링
주 프로그램안에서 cpu명령어를 이용하여 외부 장치의 상태를 반복적으로 확인
CPU프로그램에서 장치연결의 포트핀의 디지털 전압레벨에 대한 논리값을 반복적으로 일고 원하는 상태가 감지되면 알고리즘 수행단계를 변경
#### 레벨 감지
전압레벨 값 0,1 을 감지하는거
#### 에지 감지
0->1 될때 1->0될때 상승하강 변경을 감지함.


##### 문제 ) P0에 스위치 연결 스위치 동작을 폴링으로
레벨
```
# include<avr/io.h>
int main(){
	DDRB &= ~(1<<PB0);//입력
	DDRD |= (1<<PB0); //출력
	while(1){
		if(PINB&1<<PB0){
			//negative
			PORTD &= ~(1<<PD0) //off
		}else{
			//positive
			PORTD |= 1<<PD0 //on
		}
	}
	return 0;
}
```
엣지
```
# include<avr/io.h>
int main(){
	DDRB &= ~(1<<PB0);//입력
	DDRD |= (1<<PB0); //출력
	int start = PINB & 1<<PB0 ?1:0;
	while(1){
	//상승에지
		for(prev = now = start;!(now==1&&prev==0);now=start){
			prev = now;
			PORTD ^= 1<PD0; // 출력 반전.
		}
	}
	
	return 0;
}
```

### 인터럽트 
외부 또는 내부에서 발생되는 사건에 대하여 CPU 하드웨어의 도움을 받아 자동으로 감지되고, 인터럽트 서비스 루틴이 자동으로 실행 되는 메커니즘
**발생 절차**
 ① 1단계 SREG의 I-비트를 0으로 클리어, 현재 실행 중인 명령어를 실행 완료 
 ② 2단계 스택 포인터(SP)를 감소 
 ③ 3단계 PC를 SP가 가리키는 스택에 보관 
 ④ 4단계 PC에 인터럽트 벡터 주소를 넣고, 인터럽트 발생 플래그를 0으로 클리어 
 ⑤ 5단계 변경된 PC에서부터 인터럽트 서비스 루틴이 수행

##### AVR에서 인터럽트 종류 나열
외부 장치 인터럽트 INT 0~7
타이머/카운터 0,2 PWM 오버플로 OC0,2
타이머/카운터 1 신호입력 순간 PWM 오버플로
시리얼 통신 장치

##### 벡터 인터럽터
인터럽트를 처리할때 각인터럽트서비스 루틴이 미리 정의된 위치 벡터로 점프하는 방식이다.  작은 숫자의 벡터값 높은 우선순위를 가진다
Atmega에서는 우선순위 더 높은 인터럽트가 발생해도 현재 서비스 루틴은 중단하지 않고종료후에 대기인터럽트중에 높은 인터럽트 서비스루틴을 수행한다.
##### 포토 인터럽터 = 포토다이오드 + 포토트렌지스터
	적외선이 트렌지스터 베이스로 투과 , 다이오드랑 트렌지스터 간격에 자외선 차단시켜 센서동작.
- 문제) 포토인터럽터(수광발광센서 결합)를 이용하여 모터의 속도를 알고자 한다. 시스템을 설계 하고 동작을 설명하시오
	- 회전하는 물체의 한부분에 어두운 표면을 만들고 다른부분에는 밝은 표면을 만들어 포토인터럽터를 설치한다.
	- 마이크로컨트롤러에 포토인터럽터를 연결하고 포토인터럽터의 출력 상태가 변경될 때 마다 인터럽트가 발생하도록 설정한다.
	- T/C를 사용하여 인터럽트가 발생할 때마다 타이머 값을 읽어서 시간간격을 측정한다.
	- 포토인터럽터에서 발생한 인터럽트로부터 시간간격을 측정한다.

##### 문제 ) 상승엣지 TO 하강
```
EMISK |= 1 << INT0; // INT0 인터럽트 활성화 
EICRA = 3 << ISC00; // 상승에지 인터럽트 설정 끝이 1이면 상승
PORTD |= 1 << PD0; // PD0(INT0) 핀 내부에 풀업저항 설정 
sei(); // 전역 인터럽트 활성화

정답
EICRA = 2 << ISC00; // 하강에지 인터럽트 설정 끝이 0 이면하강
```


##### 문제 ) P0에 스위치 연결 스위치 동작을 인터럽트로 인식하는 방법을 코드로.
 ```
#include <avr/io.h>
#include <avr/interrupt.h>

ISR(INTO_vect){
	PORTD ^= (1<<PD0)// LED 상태 변경
	req=0;
}

int main(voiod){
	DDRD  |= (1<<PD0) // 출력
	EIMSK |= (1<< INTO); // INT0 인터럽트 활성화 
	EICRA |= (1<<ISC00);//상승

	PORTB |= 1 << PB0; // PDB(INT0) 핀 내부에 풀업저항 설정 
	sei();//전역인터럽트 활성화
	while(1){
		if(!req){//req==0
			req=1;
		}
	}
	return 0; 
}
 ```
트리거링 입력신호 == 인터럽트를 발생시키기 위해 사용되는 신호

##### 문제 ) PORT A0를 이용하여 트리거링 입력 신호를 얻고자 한다. level, positive edge와 negative edge 트리거를 감지하는 프로그램을 각각 작성하시오.

```
#include <avr/io.h>
#include <avr/interrupt.h>
int main(){

	DDRA &= ~(1<<PA0);
	EIMSK |= (1<<INTO);
	
	/*여기서 차이가남*/
	EICRA &= ~((1<<ISC01 | 1<<ISC00 ));	//LEVEL
	EICRA |= ((1<<ISC01 | 1<<ISC00 ));	//Positive
	EICRA |= (1<<ISC01);	//Positive

	sei();
	while(1){
	}
	return 0;

}

```
### 7세그먼트제어

5진 카운터 동작하는 프로그램

```c
#include <avr/io.h>

unsigned char digit[] = {0x77, 0x41, 0x3B, 0x58, 0x4D, 0x5E, 0x7C, 0x43, 0x7F, 0x4F}:
void display 7sealed(unsigned char led[l. unsigned int number){
	PORTC = led[number];
}
int main(void) { 
	DDRC = 0xFF; uint8_t count = 0; while (1) { 
		display_7segled(digit, count); 
		_delay_ms(1000); 
		count++; 
		if (count == 5) { count = 0; }
	} 
	return 0; 
}

```

### LCD 제어
##### 제어 비트
RS : 데이터(1)를 전달할건지 명령어(0)를 전달할껀지 
RW : LCD 에 데이터를 읽거(1)나 쓰는(0) 동작 나타냄
E :  데이터 or 명령을 전달할 준비(1)가 되었나?

### 타이머 카운터 T/C
#### 필요성
외부 펄스가 발생한 순간, 하드웨어적으로 계수되는 카운터 값 저장
##### 문제) 입력캡처기능이 무엇인지 무엇을 할수있는지설명
외부 펄스가 발생한 순간, 하드웨어적으로 계수되는 카운터 값 저장
외부장치가 작동하는 순간을 정밀하게 감지하는데 필요하다.

##### 문제) PWM 신호로 60Hz 디지털 신호를 출력하는 프로그램
PWM 출력 핀을 설정하고 주파수와 듀티사이클을 설정한뒤에 출력핀으로 내보낸다
#### 파형모드
일반 모드 
TCNTn to 끝까지 (TCNTn으로 주기를 바꿀 수 있음)
오버플로우 인터럽트사용
![[스크린샷 2023-12-17 오후 11.32.42.png]]
CTC 모드
한계값(OCRn)까지 샘
![[스크린샷 2023-12-17 오후 11.33.16.png]]
Fast PWM MODE
2번의 인터럽트
![[스크린샷 2023-12-17 오후 11.34.08.png]]
위상 정정PWM
업카운팅과 다운카운팅이 다일어남
![[스크린샷 2023-12-17 오후 11.35.39.png]]
8bit
![[스크린샷 2023-12-17 오후 9.32.58.png|500]]
16 bit
![[스크린샷 2023-12-17 오후 9.32.29.png|500]]


#### 듀티비
pwm duty cycle rate 듀티비 = 펄스폭시간 / 주기 * 100
고속PWM
![[스크린샷 2023-12-17 오후 9.48.51.png|300]]
위상정정
![[스크린샷 2023-12-17 오후 9.46.24.png|300]]
CTC
TCNTn 값이 OCn과 일치시 듀티비 50%



#### RC 서브 모터 동작 설명
PWM신호를 입력받음 -> 펄스폭해석 -> 모터 동작 제어 신호로 변환. -> 모터의 위치 변환
### 아날로그 비교기
##### 문제) 아날로그 비교기는 두 입력 전압의 크기를 크다 또는 작다"로 표현할 수 있다. 이를 이 용하여 검은색 테이프 라인을 따라가는 자율주행 차량을 만들고자 한다. 센서의 입력을 3개라 하면 좌, 우측 모터의 구동을 어떻게 제어할지를 설계하시오.
아날로그 센서 동작 방식: 좌측, 중앙, 우측의 아날로그 센서는 라인을 감지할 때와 감지하지 않을 때의 밝기 차이를 측정합니다. 감지된 빛의 양이 많을수록(흰색) 센서 출력 전압이 높아지고, 적을수록(검은색) 낮아 집니다. 
모터 제어 방식: 차량은 좌측, 중앙, 우측의 센서 값에 따라서 다음과 같이 동작합니다. 
	전진: 중앙 센서가 검은색을 감지하지 않을 때. 
	좌회전: 좌측 센서가 검은색을 감지할 때. 
	우회전: 우측 센서가 검은색을 감지할 때. 
모터 제어 로직: 센서 값을 읽어오고, 각각의 센서에 대한 임계값을 설정합니다. 임계값은 라인을 따라가는 데 필요한 최적의 조건에 따라 조절됩니다. 센서 값이 임계값보다 낮으면 해당 방향으로 모터를 제어합니다

##### 문제)  A/D 컨버터에서 단일 신호와 차동 신호를 이용하는 경우의 차이를 설명하시오
단일신호
	하나의 입력 신호를 a/d 컨버터에 연결하는 방식
	일반적으로 시스템에서 하나의 신호만 측정하는 경우에 사용
	장점 : 간단, 저렴, 측정신호가 하나면 유용
	단점: 노이즈나 잡음이 신호에 영향, 절대 값이아닌 차이값이 중요한경우 한계

차동신호
두개의 입력신호를 a/d컨버터에 연결하는 방식. 차이측정
장점 : 신호차를 이용하기에 노이즈에 유리
단점 : 설계 복잡, 회로 추가로 구성

### A/D 변환기
#### 레지스터
ACSR 레지스터 : 아날로그 비교기의 내부동작을 제어하고 동작 상태를 알림
SFIOR 레지스터 : 여러 장치의 입출력 핀에 대한 기능 설정을 담당하는 특수 레지스터
ADMUX 레지스터 : 단자에 연결될 A/D 변환기의 ADC 채널을 결정
##### 문제) 연속 근사(successive approximation) ADC 방식에 대하여 그 원리를 설명하시오.
- MSB부터 LSB까지 한비트씩 값을 결정.
- 아날로그 신호 선택
- ADC인터럽트 활성화 및 전역 인터럽트 활성화 비트설정
- ADC 인터럽트 서비스루틴 작성
- AD 변환 시작 명령
### 시리얼  통신
#### 종류 각각의 특징
**USART**
	비동기 동기통신 지원
	전이중 반이중 통신가능
	다양한 전송속도 지원
	비교적 장거리 통신 가능
	BUT 모든기기간의 개별적인 연결이 필요, 연결된 기기간의 전기신호 일치해야함.

**I2C**(=IIC)
	주로 마스터 슬레이브 구조
	다중 기기연결 : 여러개의 슬레이브를 I2C 버스에 연결가능
	다양한 속도와 주소 지원
	BUT 전송거리 짧음 , 복잡한 구성에는 한꼐

**SPI**
	주로 마스터 슬레이브 구조사용
	전이중 통신을 지원
	여러개의 슬레이브 장치가 SPI버스에 연결가능
	높은 데이터 전송속도
	BUT 전송 거리 짧고 복잡한 구성에 한계

#### SPI의 통신 프로토콜
동기식 시리얼 통신프로토콜
마스터 와 여러개의 슬레이브 간의 데이터 주고받음
클록신호를 사용하여 데이터 동기화
- SCK (시리얼 클록) : 데이터 동기화 위함.
- MOSI (시리얼 데이터) : 마스터 신호 출력 , 슬레이브 입력
- MISO (시리얼 데이터 입력) : 슬레이브 데이터 출력 , 마스터 입력
- SS (슬레이브 선택) : 슬레이브 선택하고 송수신 준비여부를 알린다ㅏ.


### 기타
#### ATmega128 내부 장치 5개 고르고 연결할수 잇는 응용시스템
시리얼 통신 : 시리얼 통신을 이용하여 외부 장치와 데이터를 주고 받을 수 있다. 아트메가 데이터를 pc로도 전송이 가능하다.

PWM 파형발생기 : 다양한 주파수 듀티사이클이용하여 모터제어 LED 밝기 제어 등을 할 숭 있다

ADC : 아날로그 신호를 디지털로변환하는 것으로 외부소리를 이진데이터로 변환하여 프로그램에서 쓸 수 있습니다.

타이머 카운터를 이용해서 주기적인 작업수행이 가능하다.

와치독 타이머는 오작동을 탐지하고 복구하기 위해 쓰이는 전자 타이머로 비정상이 감지되면 리셋 신호를 출력하는데 이때 원하는 동작을 집어넣어 수행할 수  있습니다.

#### 블루투스 통신 인터페이스
짧은 거리에서 작동한다. 페이렁과 연결과정을 거친다. 저전력 무선통신이다ㅏ.


